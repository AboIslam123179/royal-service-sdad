<!DOCTYPE html>
<html lang="ar" dir="rtl">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>إنشاء رابط دفع</title>
    <style>
      *{
        box-sizing: border-box;
      }
      body {
        font-family: sans-serif;
        background: #f8d7da;
        margin: 0;
        padding: 0;
      }
      .container {
        max-width: 450px;
        margin: 40px auto;
        background: #fff;
        padding: 25px;
        border-radius: 12px;
        box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
        text-align: right;
      }
      input,
      select,
      textarea {
        width: 100%;
        padding: 10px;
        margin: 7px 0;
        border-radius: 6px;
        border: 1px solid #ccc;
        font-size: 16px;
      }
      button {
        width: 100%;
        padding: 12px;
        font-size: 18px;
        background: #b51616;
        color: white;
        border: none;
        border-radius: 6px;
        cursor: pointer;
      }
      button:hover {
        opacity: 0.9;
      }
      table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 15px;
      }
      th,
      td {
        border: 1px solid #ccc;
        padding: 8px;
        text-align: center;
      }
      th {
        background: #f1f1f1;
      }
      td:first-of-type {
        font-size: 10px;
      }

      /* Popup styles */
      .popup-bg {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.4);
        justify-content: center;
        align-items: center;
      }
      .popup {
        background: #fff;
        padding: 25px;
        border-radius: 12px;
        text-align: center;
        max-width: 400px;
      }
      .popup button {
        margin-top: 15px;
        padding: 10px 15px;
        width: auto;
      }
    </style>
  </head>
  <body>

    <!-- Payment Form -->
    <div class="container">
      <h2>إنشاء رابط دفع</h2>
      <label>اسم المنتج</label><input type="text" id="productName" required />
      <label>رابط صورة</label><input type="text" id="imageLink" required />
      <label>اسم المستلم</label><input type="text" id="receiverName" required />
      <label>هاتف المستلم</label><input type="text" id="phone" required />
      <label>المبلغ</label>
      <select id="amountSelect">
        <option value>اختر السعر</option>
      </select>
      <label>الوصف</label><textarea id="desc" required></textarea>
      <button onclick="generatePaymentPage()">⚡ إنشاء رابط الدفع الآن</button>
    </div>

    <!-- Link Manager -->
    <div class="container">
      <h2>مدير الروابط والأسعار</h2>
      <label>رابط المنتج</label>
      <input type="text" id="linkInput" placeholder="ادخل رابط المنتج" />
      <label>السعر</label>
      <input type="number" id="priceInput" placeholder="ادخل السعر" />
      <button onclick="addLink()">➕ إضافة الرابط</button>

      <table id="linksTable">
        <thead>
          <tr>
            <th>الرابط</th>
            <th>السعر</th>
            <th>حذف</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>

    <!-- Popup -->
    <div class="popup-bg" id="popupBg">
      <div class="popup">
        <h3>تم إنشاء رابط الدفع!</h3>
        <p>انسخ الرابط واستخدمه:</p>
        <input
          type="text"
          id="generatedLink"
          style="width: 100%; padding: 8px; margin-top: 10px"
          readonly />
        <button onclick="copyLink()">نسخ الرابط</button>
        <button onclick="closePopup()">إغلاق</button>
      </div>
    </div>

    <script>
      let linksArray = [];

      // Replace with your deployed Vercel backend URL
      // const BACKEND_URL = "https://whop-link-generator-server.vercel.app/";
      const BACKEND_URL = "http://localhost:3000";

      // Load all links from backend
      async function loadLinks() {
        try {
          const res = await fetch(`${BACKEND_URL}/links`);
          linksArray = await res.json();
          renderTable();
          updateSelect();
        } catch (err) {
          console.error("Error loading links:", err);
        }
      }

      // Render links table
      function renderTable() {
        const tbody = document.querySelector("#linksTable tbody");
        tbody.innerHTML = "";
        linksArray.forEach((item, index) => {
          const row = document.createElement("tr");
          row.innerHTML = `<td><a href="${item.link}" target="_blank">${item.link}</a></td>
                     <td>${item.price}</td>
                     <td><button onclick="deleteLink('${item.price}')">❌</button></td>`;
          tbody.appendChild(row);
        });
      }

      // Update price dropdown in payment form
      function updateSelect() {
        const select = document.getElementById("amountSelect");
        select.innerHTML = `<option value="">اختر السعر</option>`;
        linksArray.forEach((item) => {
          const option = document.createElement("option");
          option.value = item.price;
          option.text = item.price;
          select.appendChild(option);
        });
      }

      // Add a new link via backend
      async function addLink() {
        const link = document.getElementById("linkInput").value.trim();
        const price = parseFloat(
          document.getElementById("priceInput").value.trim()
        );
        if (!link || isNaN(price)) {
          return alert("ادخل رابط وسعر صحيح");
        }

        try {
          const res = await fetch(`${BACKEND_URL}/links`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ link, price }),
          });
          const data = await res.json();
          if (res.status !== 200) return alert(data.error);

          document.getElementById("linkInput").value = "";
          document.getElementById("priceInput").value = "";
          loadLinks();
        } catch (err) {
          console.error(err);
          alert("حدث خطأ أثناء إضافة الرابط");
        }
      }

      // Delete link via backend
      async function deleteLink(price) {
        try {
          await fetch(`${BACKEND_URL}/links/${price}`, { method: "DELETE" });
          loadLinks();
        } catch (err) {
          console.error(err);
          alert("حدث خطأ أثناء حذف الرابط");
        }
      }

      // Generate payment page URL and show popup
      function generatePaymentPage() {
        const productName = encodeURIComponent(
          document.getElementById("productName").value.trim()
        );
        const img = encodeURIComponent(
          document.getElementById("imageLink").value.trim()
        );
        const receiver = encodeURIComponent(
          document.getElementById("receiverName").value.trim()
        );
        const phone = encodeURIComponent(
          document.getElementById("phone").value.trim()
        );
        const desc = encodeURIComponent(
          document.getElementById("desc").value.trim()
        );
        const amount = parseFloat(
          document.getElementById("amountSelect").value
        );

        if (
          !productName ||
          !img ||
          !receiver ||
          !phone ||
          !desc ||
          isNaN(amount)
        ) {
          return alert("املأ جميع الحقول واختر السعر");
        }

        const linkObj = linksArray.find((item) => item.price === amount);
        if (!linkObj) return alert("الرابط غير موجود لهذا السعر");

        const link = encodeURIComponent(linkObj.link);
        const paymentUrl = `${window.location.origin}/payment.html?productName=${productName}&img=${img}&receiver=${receiver}&phone=${phone}&amount=${amount}&desc=${desc}&link=${link}`;

        // Show popup
        document.getElementById("generatedLink").value = paymentUrl;
        document.getElementById("popupBg").style.display = "flex";
      }

      // Copy link from popup
      function copyLink() {
        const input = document.getElementById("generatedLink");
        input.select();
        input.setSelectionRange(0, 99999);
        navigator.clipboard
          .writeText(input.value)
          .then(() => alert("تم نسخ الرابط!"))
          .catch(() => alert("فشل النسخ"));
      }

      // Close popup
      function closePopup() {
        document.getElementById("popupBg").style.display = "none";
      }

      // Initialize
      window.onload = loadLinks;
    </script>
  </body>
</html>


